name: Progress Tracker

on:
  issues:
    types: [opened, edited, closed, reopened]
  schedule:
    - cron: '0 */2 * * *'  # 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (0, 2, 4, 6, ..., 22ì‹œ)

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas matplotlib
          
      - name: Generate Progress Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > generate_progress.py << 'EOF'
          import os
          import requests
          import pandas as pd
          import matplotlib.pyplot as plt
          from datetime import datetime
          
          # GitHub API ì„¤ì •
          token = os.environ['GITHUB_TOKEN']
          headers = {'Authorization': f'token {token}'}
          repo = os.environ['GITHUB_REPOSITORY']
          
          # ì´ìŠˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          url = f'https://api.github.com/repos/{repo}/issues?state=all'
          response = requests.get(url, headers=headers)
          issues = response.json()
          
          # ì¹´í…Œê³ ë¦¬ë³„ ì§„í–‰ë¥  ë°ì´í„° ìˆ˜ì§‘
          categories = {
              'UI/UX': [],
              'ì¸ì¦/ê¶Œí•œ': [],
              'ìº˜ë¦°ë” ì—°ë™': [],
              'ë°ì´í„° ëª¨ë¸': [],
              'ìƒíƒœ ê´€ë¦¬': [],
              'API í†µí•©': [],
              'í…ŒìŠ¤íŠ¸': []
          }
          
          for issue in issues:
              if 'feature' in [label['name'] for label in issue.get('labels', [])]:
                  body = issue['body']
                  if not body:
                      continue
                  
                  # ì¹´í…Œê³ ë¦¬ì™€ ì§„í–‰ë¥  ì¶”ì¶œ
                  try:
                      category_line = [line for line in body.split('\n') if '### ê°œë°œ ì£¼ì œ' in line][0]
                      category = category_line.split('\n')[1].strip()
                      
                      progress_line = [line for line in body.split('\n') if '### ì§„í–‰ë¥ ' in line][0]
                      progress = int(progress_line.split('\n')[1].strip())
                      
                      if category in categories:
                          categories[category].append(progress)
                  except:
                      continue
          
          # í‰ê·  ì§„í–‰ë¥  ê³„ì‚°
          progress_data = {
              category: sum(progress) / len(progress) if progress else 0
              for category, progress in categories.items()
          }
          
          # ì‹œê°í™”
          plt.figure(figsize=(12, 6))
          
          # ë§‰ëŒ€ ê·¸ëž˜í”„
          bars = plt.bar(progress_data.keys(), progress_data.values())
          plt.axhline(y=100, color='r', linestyle='--', alpha=0.3)
          
          # ìŠ¤íƒ€ì¼ë§
          plt.title('SnapCodex ê°œë°œ ì§„í–‰ë¥  í˜„í™©', pad=20)
          plt.xlabel('ê°œë°œ ì£¼ì œ')
          plt.ylabel('ì§„í–‰ë¥  (%)')
          
          # íšŒì „ëœ xì¶• ë ˆì´ë¸”
          plt.xticks(rotation=45, ha='right')
          
          # ì§„í–‰ë¥  í‘œì‹œ
          for bar in bars:
              height = bar.get_height()
              plt.text(bar.get_x() + bar.get_width()/2., height,
                      f'{height:.1f}%',
                      ha='center', va='bottom')
          
          # ì—¬ë°± ì¡°ì •
          plt.tight_layout()
          
          # ì €ìž¥
          plt.savefig('progress.png')
          
          # ë§ˆí¬ë‹¤ìš´ ë³´ê³ ì„œ ìƒì„±
          with open('progress_report.md', 'w', encoding='utf-8') as f:
              f.write('# ðŸ“Š ê°œë°œ ì§„í–‰ë¥  ë³´ê³ ì„œ\n\n')
              f.write(f'*ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}*\n\n')
              f.write('## ì¹´í…Œê³ ë¦¬ë³„ ì§„í–‰ë¥ \n\n')
              
              for category, progress in progress_data.items():
                  progress_bar = 'â–ˆ' * int(progress/10) + 'â–‘' * (10 - int(progress/10))
                  f.write(f'### {category}\n')
                  f.write(f'{progress_bar} {progress:.1f}%\n\n')
          EOF
          
          python generate_progress.py
          
      - name: Update Progress Report
        uses: EndBug/add-and-commit@v9
        with:
          add: '["progress.png", "progress_report.md"]'
          message: "docs: ê°œë°œ ì§„í–‰ë¥  ë³´ê³ ì„œ ì—…ë°ì´íŠ¸"
          default_author: github_actions 